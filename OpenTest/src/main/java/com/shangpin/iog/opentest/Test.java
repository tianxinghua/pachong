package com.shangpin.iog.opentest;

import ShangPin.SOP.Api.ApiException;
import ShangPin.SOP.Entity.Api.Purchase.PurchaseOrderDetail;
import ShangPin.SOP.Entity.Api.Purchase.PurchaseOrderDetailPage;
import ShangPin.SOP.Entity.Api.Purchase.PurchaseOrderDetailSpecial;
import ShangPin.SOP.Entity.Api.Purchase.PurchaseOrderDetailSpecialPage;
import ShangPin.SOP.Entity.DTO.PurchaseOrderDetilApiDto;
import ShangPin.SOP.Entity.DTO.PurchaseOrderInfoApiDto;
import ShangPin.SOP.Entity.Where.OpenApi.Purchase.PurchaseOrderQueryDto;
import ShangPin.SOP.Servant.OpenApiServantPrx;
import com.shangpin.framework.ServiceMessageException;
import com.shangpin.ice.ice.IcePrxHelper;
import com.shangpin.iog.dto.SpecialSkuDTO;

import java.text.SimpleDateFormat;
import java.util.*;

/**
 * Created by lizhongren on 2015/7/10.
 */
public class Test {
    public static void main(String[] args){
//        OpenApiServantPrx servant = null;
//        try {
//            servant = IcePrxHelper.getPrx(OpenApiServantPrx.class);
//        } catch (Exception e) {
//            e.printStackTrace();
//        }
//        List<Long> sopPurchaseOrderDetailNos =new ArrayList<>();
//        sopPurchaseOrderDetailNos.add(2015102600421L);
//        PurchaseOrderEx purchaseOrderEx = new PurchaseOrderEx(sopPurchaseOrderDetailNos,"ERROR! Data or Order Id or Order Site can't be empty!");
//        try {
//            System.out.print("　开始处理");
//            String  result = servant.PurchaseDetailEx(purchaseOrderEx,"2015101001584");
//            System.out.print("　返回信息" +result);
//        } catch (ApiException e) {
//            e.printStackTrace();
//        }

//        List<Integer> status = new ArrayList<>();
//        status.add(1);
//        status.add(2);
//
//
//
//        int pageIndex=1,pageSize=20;
//        OpenApiServantPrx servant = null;
//        try {
//            servant = IcePrxHelper.getPrx(OpenApiServantPrx.class);
//        } catch (Exception e) {
//            e.printStackTrace();
//        }
//        boolean hasNext=true;
//
//            Set<String> skuIds = new HashSet<String>();
//            Map<String,List<PurchaseOrderDetail>>  purchaseOrderMap = new HashMap<>();
//            String sopPurchaseOrderNo = "";
//
//            while(hasNext){
//                List<PurchaseOrderDetail> orderDetails = null;
//                try {
//
//                    PurchaseOrderQueryDto orderQueryDto = new PurchaseOrderQueryDto("2015-10-24 T 12:00:00","2015-10-24 T 12:44:00",status
//                            ,pageIndex,pageSize);
//                    PurchaseOrderDetailPage orderDetailPage=
//                            servant.FindPurchaseOrderDetailPaged("2015101001584", orderQueryDto);
//
//
//                    orderDetails = orderDetailPage.PurchaseOrderDetails;
//                } catch (Exception e) {
//                    e.printStackTrace();
//                }
//                for (PurchaseOrderDetail orderDetail : orderDetails) {
//                    sopPurchaseOrderNo  = orderDetail.SopPurchaseOrderNo;
//                    if(purchaseOrderMap.containsKey(sopPurchaseOrderNo)){
//                        //
//
//                        purchaseOrderMap.get(sopPurchaseOrderNo).add(orderDetail);
//                    }else{
//                        List<PurchaseOrderDetail> orderList = new ArrayList<>();
//                        orderList.add(orderDetail);
//                        purchaseOrderMap.put(sopPurchaseOrderNo,orderList);
//                    }
//
//
//                }
//                pageIndex++;
//                hasNext=(pageSize==orderDetails.size());
//
//            }
//        for(Iterator<Map.Entry<String,List<PurchaseOrderDetail>>> itor = purchaseOrderMap.entrySet().iterator();itor.hasNext();){
//            Map.Entry<String,List<PurchaseOrderDetail>> entry = itor.next();
//            List<PurchaseOrderDetail> orderDetailList = entry.getValue();
//            gson.toJson(orderDetailList);
//
//        }



//        OpenApiServantPrx servant = null;
//        try {
//            servant = IcePrxHelper.getPrx(OpenApiServantPrx.class);
//        } catch (Exception e) {
//            e.printStackTrace();
//        }
//        String sopPurchaseOrderNo ="";
//
//
//        List<OrderDTO>  orderDTOList= new ArrayList<>();
//        OrderDTO orderDTO1 =new OrderDTO();
//        orderDTO1.setSpOrderId("201510250199901");
//
//        orderDTOList.add(orderDTO1);
//        OrderDTO orderDTO2 =new OrderDTO();
//        orderDTO2.setSpOrderId("201510250199932");
//
//        orderDTOList.add(orderDTO2);

//        OrderDTO orderDTO3 =new OrderDTO();
//        orderDTO3.setSpOrderId("201510250196093");
//
//        orderDTOList.add(orderDTO3);
//
//        try{
//            for(OrderDTO orderDTO:orderDTOList){
//                Map<String,List<PurchaseOrderDetailSpecial>>  purchaseOrderMap = new HashMap<>();
//
//                PurchaseOrderDetailSpecialPage orderDetailSpecialPage = servant.FindPurchaseOrderDetailSpecial("2015101001584","",orderDTO.getSpOrderId());
//                if(null!=orderDetailSpecialPage&&null!=orderDetailSpecialPage.PurchaseOrderDetails&&orderDetailSpecialPage.PurchaseOrderDetails.size()>0){  //存在采购单 就代表已支付
//
//                    for (PurchaseOrderDetailSpecial orderDetail : orderDetailSpecialPage.PurchaseOrderDetails) {
//                        sopPurchaseOrderNo  = orderDetail.SopPurchaseOrderNo;
//                        if(purchaseOrderMap.containsKey(sopPurchaseOrderNo)){
//                            purchaseOrderMap.get(sopPurchaseOrderNo).add(orderDetail);
//                        }else{
//                            List<PurchaseOrderDetailSpecial> orderList = new ArrayList<>();
//                            orderList.add(orderDetail);
//                            purchaseOrderMap.put(sopPurchaseOrderNo,orderList);
//
//                        }
//
//
//                    }
//
//                    for(Iterator<Map.Entry<String,List<PurchaseOrderDetailSpecial>>> itor = purchaseOrderMap.entrySet().iterator();itor.hasNext();) {
//                        Map.Entry<String, List<PurchaseOrderDetailSpecial>> entry = itor.next();
//                        sopPurchaseOrderNo  = entry.getKey();
//                        StringBuffer purchaseOrderDetailbuffer =new StringBuffer();
//                        //获取同一产品的数量
//                        for(PurchaseOrderDetailSpecial purchaseOrderDetail:entry.getValue()){
//                            purchaseOrderDetailbuffer.append(purchaseOrderDetail.SopPurchaseOrderDetailNo).append(";");
//                            //赋值状态 海外商品每个采购单 只有一种茶品
//                            orderDTO.setSpPurchaseNo(sopPurchaseOrderNo);
//                            orderDTO.setPurchasePriceDetail(purchaseOrderDetail.SkuPrice);
//                            if(5!=purchaseOrderDetail.DetailStatus){ //5 为退款  1=待处理，2=待发货，3=待收货，4=待补发，5=已取消，6=已完成
//                                orderDTO.setStatus(OrderStatus.PAYED);
//                            }else{
//                                orderDTO.setStatus(OrderStatus.CANCELLED);
//                            }
//
//                        }
//                        orderDTO.setSpPurchaseDetailNo(purchaseOrderDetailbuffer.toString().substring(0,purchaseOrderDetailbuffer.toString().length()-1));
//
//
//                    }
//
//
//
//                }
//
//            }
//        } catch (Exception e) {
//            e.printStackTrace();
//        }

//        String kk="111";
//        if(kk.startsWith("1")){
//            System.out.println("true----" + kk.trim().startsWith("1"));
//        }else{
//            System.out.println(" false  ");
//        }

//        Gson gson = new Gson();
//        ICEWMSOrderRequestDTO  dto = new ICEWMSOrderRequestDTO();
//
//        dto.setBeginTime("2015-11-17 13:16:00");
//        dto.setEndTime("2015-11-17 13:16:20");
//        dto.setSupplierNo("S0000514");
//
//        String jsonParameter= "="+ gson.toJson(dto);
//        String result ="";
//
//
//        try {
//            result =  HttpUtil45.operateData("post","form","http://spwmsinventory.spidc1.com/Api/StockQuery/SupplierInventoryLogQuery",new OutTimeConfig(1000*5,1000*5,1000*5),null,
//                    jsonParameter,"","");
//            System.out.println("result = " + result);
//
//        } catch (ServiceException e) {
//            e.printStackTrace();
//        }
        Test test = new Test();
        try {
            test.getSopPuchase("2015082701461");//2015081701443       2015081701440    2015111601665
            List<Integer> status = new ArrayList<>();
            status.add(1);

            Map<String,List<PurchaseOrderDetailSpecial>> orderMap = null;
            orderMap =test.getPurchaseOrderSpecial("2015082701461","2016-11-14 00:00:00","2016-11-14 00:00:00",status);

            test.setStockNotUpdateBySop("2015082701461");
        } catch (Exception e) {
            e.printStackTrace();
        }

    }

    public  Map<String,List<PurchaseOrderDetailSpecial>> getPurchaseOrderSpecial(String supplierId,String startTime ,String endTime,List<Integer> statusList) throws Exception{
        int pageIndex=1,pageSize=20;
        OpenApiServantPrx servant = null;
        try {
            servant = IcePrxHelper.getPrx(OpenApiServantPrx.class);
        } catch (Exception e) {

            e.printStackTrace();
        }
        boolean hasNext=true;

        Set<String> skuIds = new HashSet<String>();
        Map<String,String>  purchaseTempMap = new HashMap<>();
        Map<String,List<PurchaseOrderDetailSpecial>>  purchaseOrderMap=  new HashMap<>();
        String sopPurchaseOrderNo = "";

        while(hasNext){
            List<PurchaseOrderDetail> orderDetails = null;
            try {

                PurchaseOrderQueryDto  orderQueryDto = new PurchaseOrderQueryDto(startTime,endTime,statusList
                        ,pageIndex,pageSize);
                System.out.println("enter servant.FindPurchaseOrderDetailPaged");
                PurchaseOrderDetailPage orderDetailPage=
                        servant.FindPurchaseOrderDetailPaged(supplierId, orderQueryDto);
                System.out.println("search servant.FindPurchaseOrderDetailPaged  end");

                orderDetails = orderDetailPage.PurchaseOrderDetails;
                if(null==orderDetails){
                    orderDetails = new ArrayList<>();
                    System.out.println("orderDetails is null");
                }else{
                    System.out.println("orderDetails is not null");
                }

            } catch (Exception e) {
                e.printStackTrace();
            }
            for (PurchaseOrderDetail orderDetail : orderDetails) {
                System.out.println(" orderDetail.GiveupType =" + orderDetail.GiveupType);
                sopPurchaseOrderNo  = orderDetail.SopPurchaseOrderNo;
                if(purchaseTempMap.containsKey(sopPurchaseOrderNo)){
                    continue;
                }else{
                    purchaseTempMap.put(sopPurchaseOrderNo,"");
                    //转化为带订单号的采购单信息
                    PurchaseOrderDetailSpecialPage orderDetailSpecialPage = servant.FindPurchaseOrderDetailSpecial(supplierId,sopPurchaseOrderNo,"");

                    if(null!=orderDetailSpecialPage&&null!=orderDetailSpecialPage.PurchaseOrderDetails&&orderDetailSpecialPage.PurchaseOrderDetails.size()>0) {  //存在采购单 就代表已支付

                        for (PurchaseOrderDetailSpecial purchaseOrderDetailSpecial : orderDetailSpecialPage.PurchaseOrderDetails) {
                            sopPurchaseOrderNo = purchaseOrderDetailSpecial.SopPurchaseOrderNo;
                            if (purchaseOrderMap.containsKey(sopPurchaseOrderNo)) {
                                purchaseOrderMap.get(sopPurchaseOrderNo).add(purchaseOrderDetailSpecial);
                            } else {
                                List<PurchaseOrderDetailSpecial> orderList = new ArrayList<>();
                                orderList.add(purchaseOrderDetailSpecial);
                                purchaseOrderMap.put(sopPurchaseOrderNo, orderList);

                            }
                        }
                    }

                }

            }
            pageIndex++;
            hasNext=(pageSize==orderDetails.size());

        }



        return purchaseOrderMap;

    }


    public  Map<String,Integer> getSopPuchase(String supplierId) throws  Exception {


        int pageIndex = 1, pageSize = 20;
        OpenApiServantPrx servant = null;
        try {
            servant = IcePrxHelper.getPrx(OpenApiServantPrx.class);
        } catch (Exception e) {
//			e.printStackTrace();
            throw e;

        }
        boolean hasNext = true;
        Set<String> skuIds = new HashSet<String>();
        Map<String, Integer> sopPurchaseMap = new HashMap<>();
        String supplierSkuNo = "";

        SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd HH:mm");
        Date endDate = new Date();
        String endTime = format.format(endDate);

        String startTime = format.format(getAppointDayFromSpecifiedDay(endDate, -10, "D"));
        List<Integer> statusList = new ArrayList<>();
        statusList.add(1);
        statusList.add(2);
        while (hasNext) {
            List<PurchaseOrderDetilApiDto> orderDetails = null;
            boolean fetchSuccess = true;

            PurchaseOrderInfoApiDto purchaseOrderInfoApiDto = null;
            for(int i=0;i<2;i++){  //允许调用失败后，再次调用一次
                try {

                    PurchaseOrderQueryDto orderQueryDto = new PurchaseOrderQueryDto(startTime,endTime,statusList
                            ,pageIndex,pageSize);
                    purchaseOrderInfoApiDto = servant.FindPurchaseOrderDetailCountPaged(supplierId, orderQueryDto);
                    if(null==purchaseOrderInfoApiDto){
                        fetchSuccess=false;
                        System.out.println("purchaseOrderInfoApiDto is null");
                    } else{
                        System.out.println("purchaseOrderInfoApiDto is not null");
                    }
                    orderDetails = purchaseOrderInfoApiDto.PurchaseOrderDetailList;
                } catch (ApiException e) {
                    e.printStackTrace();
                    fetchSuccess = false;
                } catch (Exception e) {
                    e.printStackTrace();
                    fetchSuccess = false;
                }
                if (fetchSuccess) {
                    i = 2;
                } else {
                }
            }

            for (PurchaseOrderDetilApiDto orderDetail : orderDetails) {
                supplierSkuNo = orderDetail.SupplierSkuNo;
                    System.out.println( supplierSkuNo + "　orderDetail.Count = "  + orderDetail.Count);
                sopPurchaseMap.put(supplierSkuNo, orderDetail.Count);



            }
            pageIndex++;
            hasNext = (pageSize == orderDetails.size());

        }
        return   sopPurchaseMap;
    }

        //时间处理
        private  Date getAppointDayFromSpecifiedDay(Date today,int num,String type){
            Calendar c   =   Calendar.getInstance();
            c.setTime(today);

            if("Y".equals(type)){
                c.add(Calendar.YEAR, num);
            }else if("M".equals(type)){
                c.add(Calendar.MONTH, num);
            }else if(null==type||"".equals(type)||"D".equals(type))
                c.add(Calendar.DAY_OF_YEAR, num);
            else if("H".equals(type))
                c.add(Calendar.HOUR_OF_DAY,num);
            else if("m".equals(type))
                c.add(Calendar.MINUTE,num);
            else if("S".equals(type))
                c.add(Calendar.SECOND,num);
            return c.getTime();
        }


    public void setStockNotUpdateBySop(String supplierId){
        OpenApiServantPrx servant = null;
        try {
            servant = IcePrxHelper.getPrx(OpenApiServantPrx.class);
        } catch (Exception e) {

            e.printStackTrace();
        }

       System.out.println("获取采购异常的商品开始");
        List<PurchaseOrderDetail> orderDetails = null;
        boolean hasNext=true;
        String endTime = "";
        String startTime = "";

        SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd HH:mm");
        Date endDate = new Date();
        endTime = format.format(endDate);
        startTime = format.format(getAppointDayFromSpecifiedDay(endDate, -1, "D"));


        List<java.lang.Integer> statusList = new ArrayList<>();
        statusList.add(7);
        int pageIndex=1,pageSize=20;

        while(hasNext){
            PurchaseOrderQueryDto orderQueryDto = new PurchaseOrderQueryDto(startTime,endTime,statusList
                    ,pageIndex,pageSize);
            try {
                PurchaseOrderDetailPage orderDetailPage=
                        servant.FindPurchaseOrderDetailPaged(supplierId, orderQueryDto);
                orderDetails = orderDetailPage.PurchaseOrderDetails;
                if(null==orderDetails){
                    System.out.println("orderDetails is null");
                }else{
                    System.out.println("orderDetails is not null");
                }

                for (PurchaseOrderDetail orderDetail : orderDetails) {
                    System.out.println(" orderDetail.GiveupType =" + orderDetail.GiveupType);
                    if(7!=orderDetail.GiveupType){

                        //直接调用库存更新  库存为0
                        try {
                     //       servant.UpdateStock(supplierId, orderDetail.SkuNo, 0);
                        } catch (Exception e) {
                            e.printStackTrace();
                           System.out.println("采购异常的商品 "+ orderDetail.SkuNo + " 库存更新失败。");
                        }

                    }else{
                        System.out.println("异常采购信息："+ orderDetail.SopPurchaseOrderNo + " 因质量问题采购异常，可继续更新库存");
                    }

                }
            } catch (Exception e) {
                if(orderDetails==null){
                    orderDetails = new ArrayList<PurchaseOrderDetail>();
                }
                e.printStackTrace();
            }
            pageIndex++;
            hasNext=(pageSize==orderDetails.size());
        }

    }
}
