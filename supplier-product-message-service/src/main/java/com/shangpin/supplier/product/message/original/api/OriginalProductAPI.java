package com.shangpin.supplier.product.message.original.api;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import com.shangpin.ephub.client.message.original.body.SupplierProduct;
import com.shangpin.ephub.client.message.original.body.SupplierStock;
import com.shangpin.supplier.product.message.common.e.Code;
import com.shangpin.supplier.product.message.common.response.APIRsponse;
import com.shangpin.supplier.product.message.original.service.OriginalProductService;
import com.shangpin.supplier.product.message.original.service.SupplierStockService;

import lombok.extern.slf4j.Slf4j;

/**
 * <p>Title:OriginalProductAPI.java </p>
 * <p>Description: </p>
 * <p>Company: www.shangpin.com</p> 
 * @author yanxiaobin
 * @date 2016年12月6日 下午2:29:24
 */
@RestController
@Slf4j
@RequestMapping(value = "/message/api")
public class OriginalProductAPI {

	@Autowired
	private OriginalProductService originalProductService;
	@Autowired
	private SupplierStockService supplierStockService;
	
	@RequestMapping(value = "/original-product")
	public APIRsponse stockSync(@RequestBody SupplierProduct supplierProduct){
		long start = System.currentTimeMillis();
		APIRsponse apiRsponse = null;
		try {
			if (originalProductService.dispatchOriginalProduct(supplierProduct)) {
				apiRsponse = new APIRsponse(Code.OK.getCode(), Code.OK.getMessage());
			} else {
				apiRsponse = new APIRsponse(Code.NO.getCode(), Code.NO.getMessage());
			}
		} catch (Exception e) {
			log.error("系统发生异常："+e.getMessage(), e);
			e.printStackTrace();
			apiRsponse = new APIRsponse(Code.NO.getCode(), e.getMessage());
		}
		log.info("系统成功发送编号为{}的消息耗时{}milliseconds",supplierProduct.getMessageId(),System.currentTimeMillis()-start);
		return apiRsponse;
	}
	
	@RequestMapping(value = "/original-stock", method = RequestMethod.POST)
	public APIRsponse updateStock(@RequestBody SupplierStock supplierStock){
		APIRsponse apiRsponse = null;
		boolean result = supplierStockService.sendMessageToChannel(supplierStock);
		if(result){
			apiRsponse = new APIRsponse(Code.OK.getCode(), Code.OK.getMessage());
		}else{
			apiRsponse = new APIRsponse(Code.NO.getCode(), Code.NO.getMessage());
		}
		return apiRsponse;
	}
}
